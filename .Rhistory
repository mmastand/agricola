clean_html <- function(html_string) {
h <- gsub("<.*?>", "", html_string) # trim html tags
h <- gsub("^[ \t]", "", h) # trim whitespace
h <- gsub("\n", "", h)
return(h)
}
big <- read_3p_game(games[1])
library(tidyverse)
big <- read_3p_game(games[1])
library(rvest)
big <- read_3p_game(games[1])
games <- c(
"2097152",
"2216597",
"2289311",
"2612686",
"2841506",
"2879452",
"2884706",
"2893836",
"2909986",
"2930316",
"2942212",
"2944181",
"2944318",
"2950053",
"2950286",
"2962750",
"2971737",
"2971938",
"2977650",
"2978704",
"2990972")
big <- read_3p_game(games[1])
big
# pull data from a game history
html <- read_html("http://www.boiteajeux.net/jeux/agr/historique.php?id=2990972")
# select first player, first round
t <- html_nodes(html, '.clHistoFonce:nth-child(15) .clHisto:nth-child(2)')
hs <- as.character(xml_contents(t))
clean_html(hs)
round_num <- 1
res = c()
round_html <- c(15:1)[round_num]
for (i in c(2,3,4)) {
t <- html_nodes(html,
paste0('.clHistoFonce:nth-child(', round_html, ') .clHisto:nth-child(', i, ')'))
hs <- as.character(xml_contents(t))
clean <- clean_html(hs)
res[str_length(clean) != 1] <- clean[str_length(clean) != 1]
}
res <- rev(res)
res
t <- html_nodes(html, '.clHistoFonce')
t
hs <- as.character(xml_contents(t))
clean_html(hs)
t <- html_nodes(html,
paste0('.clHistoFonce:nth-child(', round_html, ') .clHisto:nth-child(', i, ')'))
hs <- as.character(xml_contents(t))
clean_html(hs)
big
for (i in c(2,3,4)) {
# Get player name
t <- html_nodes(html,
paste0('tr:nth-child(', i, ') th:nth-child(1)'))
player_name <-  as.character(xml_contents(t))[2]
# Get cards used
# t <- html_nodes(html,
#                 paste0('tr:nth-child(', i, ') span'))
# cards <- as.character(xml_contents(t))
# cards <- strsplit(cards, " =")
# cards <- as.numeric(purrr::map(cards, `[[`, 1))
# if (is_empty(cards)) {
#   cards <- NA
#   num_cards <- 0
# } else {
#   num_cards <- length(cards)
# }
# Get player score
t <- html_nodes(html,
paste0('.clScore tr:nth-child(', i, ') td'))
cats <- as.numeric(as.character(xml_contents(t)))
cats <- cats[!is.na(cats)]
# Combine
temp <- data.frame(game_id = game_id,
player_name = player_name,
fields = cats[1],
pastures = cats[2],
grain = cats[3],
vegetables = cats[4],
sheeps = cats[5],
wild_boars = cats[6],
cattles = cats[7],
unused_spaces = cats[8],
fenced_stables = cats[9],
rooms = cats[10],
family_members = cats[11],
card_points = cats[12],
bonus_points = cats[13],
order = i - 1)
temp$total_score <- rowSums(temp[, 3:15])
res <- bind_rows(res, temp)
}
res$place <- dense_rank(desc(res$total_score))
return(res)
}
read_3p_game <- function(game_id) {
html <- read_html(paste0("http://www.boiteajeux.net/jeux/agr/partie.php?id=", game_id))
res <- data.frame(game_id = NULL,
player_name = NULL,
fields = NULL,
pastures = NULL,
grain = NULL,
vegetables = NULL,
sheeps = NULL,
wild_boars = NULL,
cattles = NULL,
unused_spaces = NULL,
fenced_stables = NULL,
rooms = NULL,
family_members = NULL,
card_points = NULL,
bonus_points = NULL,
card_id = NULL)
for (i in c(2,3,4)) {
# Get player name
t <- html_nodes(html,
paste0('tr:nth-child(', i, ') th:nth-child(1)'))
player_name <-  as.character(xml_contents(t))[2]
# Get cards used
# t <- html_nodes(html,
#                 paste0('tr:nth-child(', i, ') span'))
# cards <- as.character(xml_contents(t))
# cards <- strsplit(cards, " =")
# cards <- as.numeric(purrr::map(cards, `[[`, 1))
# if (is_empty(cards)) {
#   cards <- NA
#   num_cards <- 0
# } else {
#   num_cards <- length(cards)
# }
# Get player score
t <- html_nodes(html,
paste0('.clScore tr:nth-child(', i, ') td'))
cats <- as.numeric(as.character(xml_contents(t)))
cats <- cats[!is.na(cats)]
# Combine
temp <- data.frame(game_id = game_id,
player_name = player_name,
fields = cats[1],
pastures = cats[2],
grain = cats[3],
vegetables = cats[4],
sheeps = cats[5],
wild_boars = cats[6],
cattles = cats[7],
unused_spaces = cats[8],
fenced_stables = cats[9],
rooms = cats[10],
family_members = cats[11],
card_points = cats[12],
bonus_points = cats[13],
order = i - 1)
temp$total_score <- rowSums(temp[, 3:15])
res <- bind_rows(res, temp)
}
res$place <- dense_rank(desc(res$total_score))
return(res)
}
big <- read_3p_game(games[1])
gib
big
big <- read_3p_game("2990972")
big
game <- read_3p_game("2990972")
game <- read_3p_game("2990972")
game$player_name
res = data.frame(player_name = NULL,
round_number = NULL,
action = NULL)
round_html <- c(15:1)[round_num]
i = 2
t <- html_nodes(html,
paste0('.clHistoFonce:nth-child(', round_html, ') .clHisto:nth-child(', i, ')'))
hs <- as.character(xml_contents(t))
clean <- clean_html(hs)
inds <- str_length(clean) != 1 # Action for that player
res$action[inds] <- clean[inds]
res <- NULL
res$action[inds] <- clean[inds]
res
res$player_name[inds] <- summ[i - 1]
res$player_name[inds] <- game$player_name[i - 1]
res
round_num <- 1
# res = data.frame(player_name = NULL,
#                  round_number = NULL,
#                  action = NULL)
round_html <- c(15:1)[round_num]
for (i in c(2,3,4)) {
t <- html_nodes(html,
paste0('.clHistoFonce:nth-child(', round_html, ') .clHisto:nth-child(', i, ')'))
hs <- as.character(xml_contents(t))
clean <- clean_html(hs)
inds <- str_length(clean) != 1 # Actions for that player
res$action[inds] <- clean[inds]
res$player_name[inds] <- game$player_name[i - 1]
res$round_number[inds] <- round_num
}
res <- data.frame(rev(res))
res
grep('Occupation', res$action)
grepl('Occupation', res$action)
grepl('occupation', res$action)
substr(res$action, 1)
substr(res$action, 1, 2)
substr(res$action, 1, 1)
substr(res$action, -1)
str_sub(res$action, -1)
str_sub(res$action, 1, 1)
?str_sub
str_sub(res$action, 1, -1)
str_sub(res$action, 2, -1)
get_player_name <- function(html) {
for (i in c(2, 3, 4)) {
t <- html_nodes(html,
paste0('tr:nth-child(', i, ') th:nth-child(1)'))
names[i - 1] <-  as.character(xml_contents(t))[2]
}
return(names)
}
get_player_name(html)
get_player_names <- function(html) {
for (i in c(2, 3, 4)) {
t <- html_nodes(html,
paste0('tr:nth-child(', i, ') th:nth-child(1)'))
player_names[i - 1] <-  as.character(xml_contents(t))[2]
}
return(player_name)
}
get_player_name(html)
get_player_names <- function(html) {
for (i in c(2, 3, 4)) {
t <- html_nodes(html,
paste0('tr:nth-child(', i, ') th:nth-child(1)'))
player_names[i - 1] <-  as.character(xml_contents(t))[2]
}
return(player_names)
}
get_player_name(html)
get_player_names(html)
player_names <- c(NA, NA, NA)
get_player_names <- function(html) {
player_names <- c(NA, NA, NA)
for (i in c(2, 3, 4)) {
t <- html_nodes(html,
paste0('tr:nth-child(', i, ') th:nth-child(1)'))
player_names[i - 1] <-  as.character(xml_contents(t))[2]
}
return(player_names)
}
get_player_names(html)
r
t
i
t <- html_nodes(html,
paste0('tr:nth-child(', i, ') th:nth-child(1)'))
t
as.character(xml_contents(t))[2]
html
game_id
# Pull data from game summary -------------------------------------------------
game_id <- 2990972
html <- read_html(paste0("http://www.boiteajeux.net/jeux/agr/partie.php?id=", game_id))
i = 2
t <- html_nodes(html,
paste0('tr:nth-child(', i, ') th:nth-child(1)'))
t
get_player_names(html)
get_round <- function(html, round_num) {
# Get player names
player_names <- get_player_names(html)
round_html <- c(15:1)[round_num]
for (i in c(2,3,4)) {
t <- html_nodes(html,
paste0('.clHistoFonce:nth-child(', round_html, ') .clHisto:nth-child(', i, ')'))
hs <- as.character(xml_contents(t))
clean <- clean_html(hs)
inds <- str_length(clean) != 1 # Actions for that player
# build round output
res$player_name[inds] <- game_summary$player_name[i - 1]
res$round_num[inds] <- round_num
res$action[inds] <- clean[inds]
res$occupation_flag <-
}
res <- data.frame(rev(res))
res$turn_num <- str_sub(res$action, 1, 1)
res$action <- str_sub(res$action, 2, -1)
}
get_round <- function(html, round_num) {
# Get player names
player_names <- get_player_names(html)
round_html <- c(15:1)[round_num]
for (i in c(2,3,4)) {
t <- html_nodes(html,
paste0('.clHistoFonce:nth-child(', round_html, ') .clHisto:nth-child(', i, ')'))
hs <- as.character(xml_contents(t))
clean <- clean_html(hs)
inds <- str_length(clean) != 1 # Actions for that player
# build round output
res$player_name[inds] <- game_summary$player_name[i - 1]
res$round_num[inds] <- round_num
res$action[inds] <- clean[inds]
}
res <- data.frame(rev(res))
res$turn_num <- str_sub(res$action, 1, 1)
res$action <- str_sub(res$action, 2, -1)
}
round <- get_round(html, 1)
get_round <- function(html, round_num) {
# Get player names
player_names <- get_player_names(html)
round_html <- c(15:1)[round_num]
for (i in c(2,3,4)) {
t <- html_nodes(html,
paste0('.clHistoFonce:nth-child(', round_html, ') .clHisto:nth-child(', i, ')'))
hs <- as.character(xml_contents(t))
clean <- clean_html(hs)
inds <- str_length(clean) != 1 # Actions for that player
# build round output
res$player_name[inds] <- player_names[i - 1]
res$round_num[inds] <- round_num
res$action[inds] <- clean[inds]
}
res <- data.frame(rev(res))
res$turn_num <- str_sub(res$action, 1, 1)
res$action <- str_sub(res$action, 2, -1)
}
round <- get_round(html, 1)
round
get_round <- function(html, round_num) {
# Get player names
player_names <- get_player_names(html)
round_html <- c(15:1)[round_num]
for (i in c(2,3,4)) {
t <- html_nodes(html,
paste0('.clHistoFonce:nth-child(', round_html, ') .clHisto:nth-child(', i, ')'))
hs <- as.character(xml_contents(t))
clean <- clean_html(hs)
inds <- str_length(clean) != 1 # Actions for that player
# build round output
res$player_name[inds] <- player_names[i - 1]
res$round_num[inds] <- round_num
res$action[inds] <- clean[inds]
}
res <- data.frame(rev(res))
res$turn_num <- str_sub(res$action, 1, 1)
res$action <- str_sub(res$action, 1, -1)
}
round <- get_round(html, 1)
r
round
get_round <- function(html, round_num) {
round_html <- c(15:1)[round_num]
for (i in c(2,3,4)) {
t <- html_nodes(html,
paste0('.clHistoFonce:nth-child(', round_html, ') .clHisto:nth-child(', i, ')'))
hs <- as.character(xml_contents(t))
clean <- clean_html(hs)
inds <- str_length(clean) != 1 # Actions for that player
# build round output
res$player_name[inds] <- game_summary$player_names[i - 1]
res$round_num[inds] <- round_num
res$action[inds] <- clean[inds]
}
res <- data.frame(rev(res))
res$turn_num <- str_sub(res$action, 1, 1)
res$action <- str_sub(res$action, 1, -1)
return(res)
}
# Pull turn history
html <- read_html(paste0("http://www.boiteajeux.net/jeux/agr/historique.php?id=", game_id))
get_round(game_id)
get_round(game_id, 1)
game_id
# Pull data from game summary -------------------------------------------------
game_id <- "2990972"
# Pull turn history
html <- read_html(paste0("http://www.boiteajeux.net/jeux/agr/historique.php?id=", game_id))
get_round(game_id, 1)
t <- html_nodes(html,
paste0('.clHistoFonce:nth-child(', round_html, ') .clHisto:nth-child(', i, ')'))
t
get_round <- function(html, round_num, game_summary) {
round_html <- c(15:1)[round_num]
for (i in c(2,3,4)) {
t <- html_nodes(html,
paste0('.clHistoFonce:nth-child(', round_html, ') .clHisto:nth-child(', i, ')'))
hs <- as.character(xml_contents(t))
clean <- clean_html(hs)
inds <- str_length(clean) != 1 # Actions for that player
# build round output
res$player_name[inds] <- game_summary$player_names[i - 1]
res$round_num[inds] <- round_num
res$action[inds] <- clean[inds]
}
res <- data.frame(rev(res))
res$turn_num <- str_sub(res$action, 1, 1)
res$action <- str_sub(res$action, 1, -1)
return(res)
}
get_round(game_id, 1, game)
source('~/Documents/Repos/agricola/code/functions.R')
# Pull data from game summary -------------------------------------------------
game_id <- "2990972"
summ <- read_3p_game(game_id)
summ
source('~/Documents/Repos/agricola/code/functions.R')
game <- read_3p_game(game_id)
game
html <- read_html(paste0("http://www.boiteajeux.net/jeux/agr/historique.php?id=", game_id))
round <- get_round(html = html, round_num = 1, game_summary = game)
source('~/Documents/Repos/agricola/code/functions.R')
round <- get_round(html = html, round_num = 1, game_summary = game)
round
source('~/Documents/Repos/agricola/code/functions.R')
get_round(html = html, round_num = 1, game_summary = game)
source('~/Documents/Repos/agricola/code/functions.R')
round <- get_round(html = html, round_num = 1, game_summary = game)
round
source('~/Documents/Repos/agricola/code/functions.R')
round <- get_round(html = html, round_num = 1, game_summary = game)
res
res <- data.frame(rev(res))
res
round <- get_round(html = html, round_num = 1, game_summary = game)
rev(res)
rev(res)
rev(res$action)
source('~/Documents/Repos/agricola/code/functions.R')
round <- get_round(html = html, round_num = 1, game_summary = game)
source('~/Documents/Repos/agricola/code/functions.R')
round <- get_round(html = html, round_num = 1, game_summary = game)
round
source('~/Documents/Repos/agricola/code/functions.R')
round
round <- get_round(html = html, round_num = 1, game_summary = game)
round
source('~/Documents/Repos/agricola/code/functions.R')
?map_df
round <- get_round(html = html, round_num = 14, game_summary = game)
round
round <- get_round(html = html, round_num = 13, game_summary = game)
round
round <- get_round(html = html, round_num = 15, game_summary = game)
round
game_history <- map_df(1:14, get_round, html = html, game_summary = game)
game_history
3/2
1.5%2
1.5 % 2
1.5 %% 2
5 %% 2
4 %% 2
source('~/Documents/Repos/agricola/code/functions.R')
round <- get_round(html = html, round_num = 2, game_summary = game)
round
game_history <- map_df(1:14, get_round, html = html, game_summary = game)
source('~/Documents/Repos/agricola/code/functions.R')
source('~/Documents/Repos/agricola/code/functions.R')
game_history
round
str_detect(game_history$action, "^:digit:")
str_detect(game_history$action, "[^:digit:]")
str_extract(game_history$action, "[^:digit:]")
source('~/Documents/Repos/agricola/code/functions.R')
d <- c("1hell", "2 my dill", "35tads", "752grainz")
str_extract(d, "[^:digit:]")
str_extract(d, "[^\d]")
str_extract(d, "[^/d]")
str_extract(d, "[/d]")
str_extract(d, "[":digits:]")
str_extract(d, "[:digits:]")
str_extract(d, "[:digit:]")
d <- c("none", "1hell", "2 my dill", "35tads", "752grainz")
str_extract(d, "[:digit:+]")
str_extract(d, "[{^\d+}]")
str_extract(d, "[{^\\d+}]")
str_extract(d, "[^{\\d+}]")
str_extract(d, "[{\\d+}]")
str_extract(d, "[{[0-9]+}]")
str_extract(d, "[[0-9]+]")
str_extract(d, "[0-9]+")
source('~/Documents/Repos/agricola/code/functions.R')
game_history <- map_df(1:14, get_round, html = html, game_summary = game)
game_history
str_extract(d, "^[0-9]+")
d <- c("none", "1hell", "2 my dill", "35tad2s", "752grainz4")
str_extract(d, "^[0-9]+")
source('~/Documents/Repos/agricola/code/functions.R')
str_replace(d, "^[0-9]+",replacement = "")
source('~/Documents/Repos/agricola/code/functions.R')
game_history <- map_df(1:14, get_round, html = html, game_summary = game)
game_history
source('~/Documents/Repos/agricola/code/functions.R')
game_history
game_history <- map_df(1:14, get_round, html = html, game_summary = game)
game_history
game_history
View(game)
game
